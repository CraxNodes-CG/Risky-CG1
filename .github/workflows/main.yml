name: Ubuntu VPS

on:
  workflow_dispatch:
  push:
    branches:
      - vm-data

jobs:
  run:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: 🧩 Setup VM Environment
        run: |
          sudo apt update -y
          sudo apt install -y git screen curl
          git config --global user.email "actions@github.com"
          git config --global user.name "github-actions"

      - name: 📦 Restore VM Data
        run: |
          mkdir -p $GITHUB_WORKSPACE/vm_data
          cd $GITHUB_WORKSPACE
          git fetch origin vm-data || git checkout -b vm-data
          git checkout vm-data || git checkout -b vm-data
          git pull origin vm-data || true
          rsync -av --exclude='.git' . ./vm_data/ || true
          echo "✅ VM data restored successfully."

      - name: 🚀 Start SSHX VM (Persistent)
        run: |
          cd $GITHUB_WORKSPACE/vm_data
          curl -sSf https://sshx.io/get | sh -s run > sshx.log 2>&1 &
          echo "✅ SSHX VM started in background."
          echo "🔁 Starting heartbeat autosave..."
          (
            while true; do
              sleep 2
              echo "💾 Auto-saving VM data..."
              cd $GITHUB_WORKSPACE/vm_data
              git add .
              git commit -m "Auto-save $(date)" || true
              git push origin vm-data || true
            done
          ) &
          echo "✅ Heartbeat & autosave running (every 2 seconds)."

      - name: 🧠 Run Until Manual Stop
        run: |
          echo "⏳ VM running... press stop to end workflow."
          sleep infinity

      - name: 💾 Final Save & Auto Restart
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          echo "📦 Runner shutting down — saving final data..."
          cd $GITHUB_WORKSPACE/vm_data
          git add .
          git commit -m "Final save $(date)" || true
          git push origin vm-data || true
          echo "✅ Final data saved."

          echo "♻️ Logging restart..."
          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/main.yml/dispatches \
            -d '{"ref":"main"}'
          echo "✅ Restart request sent to GitHub API!"
